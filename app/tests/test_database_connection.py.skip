"""Test database connection and session management."""

import pytest
from sqlalchemy.ext.asyncio import AsyncSession

from app.database.connection import PostgreSQLDatabaseService


@pytest.mark.integration
async def test_get_engine() -> None:
    """Test database engine creation."""
    engine = get_engine(test=True)
    assert engine is not None
    assert str(engine.url).startswith("postgresql+asyncpg://")


@pytest.mark.integration
async def test_get_session_factory() -> None:
    """Test session factory creation."""
    factory = get_session_factory(test=True)
    assert factory is not None


@pytest.mark.integration
async def test_db_session_fixture(db_session: AsyncSession) -> None:
    """Test database session fixture provides valid session."""
    assert db_session is not None
    assert isinstance(db_session, AsyncSession)
    assert not db_session.in_transaction()


@pytest.mark.integration
async def test_db_session_context_manager() -> None:
    """Test database session context manager."""
    async for session in get_db_session():
        assert session is not None
        assert isinstance(session, AsyncSession)
        break


@pytest.mark.integration
async def test_db_session_rollback_on_error(db_session: AsyncSession) -> None:
    """Test that session rolls back on error."""
    from sqlalchemy import text

    try:
        # Execute invalid SQL to trigger error
        await db_session.execute(text("SELECT * FROM nonexistent_table"))
    except Exception:
        # Error should trigger rollback
        assert not db_session.in_transaction()
